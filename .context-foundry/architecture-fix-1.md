# Architecture Fix 1

## Test Failures Summary

The project cannot compile due to **29 TypeScript errors** (13 server + 16 client). All errors are blocking - no runtime tests can execute until these are resolved.

**Error Categories:**
1. JWT token generation type mismatch (2 errors)
2. Missing `offset` property in query types (12+ errors across multiple files)
3. Wrong Input component prop name (1 error)
4. Missing Vite type definitions (1 error)
5. useOfflineSync ID type error (1 error)
6. Unused imports/variables (10+ errors)
7. ParsedQs type conversion errors (2 errors)

---

## Root Cause Analysis

### Issue 1: JWT `expiresIn` Type Mismatch
**Root Cause:** The `jsonwebtoken` library's `SignOptions` type expects `expiresIn` to be `number | StringValue | undefined`, but `process.env.JWT_EXPIRES_IN || '15m'` is typed as `string`. The environment variable returns `string | undefined`, which after the `||` operator becomes a plain `string` type, not the specific `StringValue` type that `jwt.sign` expects.

### Issue 2: Zod `.default()` Not Making Fields Optional
**Root Cause:** In Zod, `.default()` provides a default value at **parse time**, but the inferred TypeScript type still treats the field as required. The schemas use:
```typescript
offset: z.coerce.number().int().min(0).default(0)
```
The TypeScript type `z.infer<typeof sleepLogQuerySchema>` makes `offset` required, causing all call sites that don't provide `offset` to fail type-checking.

### Issue 3: Prop Name Mismatch
**Root Cause:** The `Input` component defines `helperText` prop, but `Register.tsx` uses `hint`. Simple typo/API mismatch.

### Issue 4: Missing Vite Types
**Root Cause:** The client `tsconfig.json` doesn't include Vite client types, so `import.meta.env` is not recognized. Vite provides type augmentation through `vite/client`, but this reference is missing.

### Issue 5: useOfflineSync ID Property Error
**Root Cause:** The `pendingMutations.add()` function expects `Omit<PendingMutation, 'id'>`, but the code passes an object that includes `id: crypto.randomUUID()`. This is a design choice issue - the ID is being generated client-side when it should either be auto-generated by the database, or the type should accept `id`.

### Issue 6: Unused Imports/Variables
**Root Cause:** TypeScript strict mode (`noUnusedLocals: true`, `noUnusedParameters: true`) flags all unused declarations as errors. Several files have imports or parameters that were added but never used.

### Issue 7: ParsedQs Type Conversion
**Root Cause:** Express's `req.query` is typed as `ParsedQs` (which allows nested objects and arrays). Direct casting to the Zod-inferred type fails because the types don't overlap. Need to cast through `unknown` first.

---

## Required Changes

### File: `server/src/middleware/auth.ts`
**Problem:** JWT `expiresIn` option type mismatch
**Fix:** Import `SignOptions` type and use explicit typing for the options object.

**Lines 29-45, replace the two functions:**
```typescript
import type { SignOptions } from 'jsonwebtoken';

// Generate JWT token
export function generateToken(userId: number, email: string): string {
  const options: SignOptions = {
    expiresIn: (process.env.JWT_EXPIRES_IN || '15m') as string
  };
  return jwt.sign(
    { userId, email } as JwtPayload,
    JWT_SECRET,
    options
  );
}

// Generate refresh token
export function generateRefreshToken(userId: number, email: string): string {
  const options: SignOptions = {
    expiresIn: (process.env.JWT_REFRESH_EXPIRES_IN || '7d') as string
  };
  return jwt.sign(
    { userId, email } as JwtPayload,
    JWT_SECRET,
    options
  );
}
```

**Lines 103-139** - Fix unused `res` parameter in `optionalAuth`:
Change `res: Response` to `_res: Response`.

---

### File: `shared/schemas/sleepLog.ts`
**Problem:** `offset` and `limit` fields required in TypeScript type despite having defaults
**Fix:** Chain `.optional()` before `.default()` to make the TypeScript type reflect that these fields are optional at the input level.

**Lines 49-54, replace `sleepLogQuerySchema`:**
```typescript
export const sleepLogQuerySchema = z.object({
  startDate: z.string().regex(/^\d{4}-\d{2}-\d{2}$/).optional(),
  endDate: z.string().regex(/^\d{4}-\d{2}-\d{2}$/).optional(),
  limit: z.coerce.number().int().min(1).max(100).optional().default(30),
  offset: z.coerce.number().int().min(0).optional().default(0),
});
```

---

### File: `shared/schemas/diaryEntry.ts`
**Problem:** Same as sleepLog - `offset` and `limit` fields required despite having defaults
**Fix:** Chain `.optional()` before `.default()`.

**Lines 58-63, replace `diaryEntryQuerySchema`:**
```typescript
export const diaryEntryQuerySchema = z.object({
  startDate: z.string().regex(/^\d{4}-\d{2}-\d{2}$/).optional(),
  endDate: z.string().regex(/^\d{4}-\d{2}-\d{2}$/).optional(),
  limit: z.coerce.number().int().min(1).max(100).optional().default(30),
  offset: z.coerce.number().int().min(0).optional().default(0),
});
```

---

### File: `client/src/pages/Register.tsx`
**Problem:** Using `hint` prop instead of `helperText`
**Fix:** Change prop name.

**Line 90, change:**
```tsx
// FROM:
hint="At least 8 characters"
// TO:
helperText="At least 8 characters"
```

---

### File: `client/src/vite-env.d.ts` (CREATE NEW FILE)
**Problem:** Vite type definitions missing
**Fix:** Create a type declaration file that references Vite client types.

**Create new file with content:**
```typescript
/// <reference types="vite/client" />
```

---

### File: `client/src/hooks/useOfflineSync.ts`
**Problem:** Passing `id` property in object typed as `Omit<PendingMutation, 'id'>`
**Fix:** The `pendingMutations.add()` in `client/src/lib/db.ts` expects `Omit<PendingMutation, 'id'>`, but we need to pass the ID. Update the `add` function type in db.ts to accept the full `PendingMutation` type since we're generating IDs client-side.

**File: `client/src/lib/db.ts`, line 99, change function signature:**
```typescript
// FROM:
async add(mutation: Omit<PendingMutation, 'id'>): Promise<void> {
  await db.pendingMutations.add(mutation as PendingMutation);
}

// TO:
async add(mutation: PendingMutation): Promise<void> {
  await db.pendingMutations.add(mutation);
}
```

---

### File: `server/src/routes/sleepLogs.ts`
**Problem:** ParsedQs type conversion error on line 24
**Fix:** Cast through `unknown` first.

**Line 24, change:**
```typescript
// FROM:
const query = req.query as z.infer<typeof sleepLogQuerySchema>;

// TO:
const query = req.query as unknown as z.infer<typeof sleepLogQuerySchema>;
```

---

### File: `server/src/routes/diaryEntries.ts`
**Problem:** ParsedQs type conversion error on line 24
**Fix:** Cast through `unknown` first.

**Line 24, change:**
```typescript
// FROM:
const query = req.query as z.infer<typeof diaryEntryQuerySchema>;

// TO:
const query = req.query as unknown as z.infer<typeof diaryEntryQuerySchema>;
```

---

### File: `server/src/jobs/insightGenerator.ts`
**Problem:** Unused variable `task` on line 55
**Fix:** Prefix with underscore or remove the variable assignment.

**Line 55, change:**
```typescript
// FROM:
const task = cron.schedule(cronSchedule, async () => {

// TO:
cron.schedule(cronSchedule, async () => {
```

---

### File: `server/src/lib/migrate.ts`
**Problem:** Unused imports `migrate`, `db`, `schema` on lines 1-3
**Fix:** Remove unused imports since the file uses direct SQL execution via `sqlite.exec()`.

**Lines 1-3, change:**
```typescript
// FROM:
import { migrate } from 'drizzle-orm/better-sqlite3/migrator';
import { db, sqlite } from './db.js';
import * as schema from '../models/schema.js';

// TO:
import { sqlite } from './db.js';
```

---

### File: `server/src/middleware/errorHandler.ts`
**Problem:** Unused parameter `res` on line 85 (notFoundHandler function)
**Fix:** This is a false positive in the test report - looking at the actual code, line 85 does use `res`. However, line 51 has `next` marked as unused. The eslint-disable comment is present but may not be working.

**Line 51 already has the correct eslint-disable comment. No change needed if eslint is configured. If TypeScript alone is flagging this, prefix with underscore:**
```typescript
// The next parameter is required by Express error handler signature
// If still erroring, change to:
_next: NextFunction
```

---

### File: `server/src/services/aiService.ts`
**Problem:** Unused import `openai` on line 1
**Fix:** The import brings in `generateCompletion` and `ChatMessage` type which ARE used. Remove the default `openai` import.

**Line 1, change:**
```typescript
// FROM:
import openai, { generateCompletion, type ChatMessage } from '../lib/openai.js';

// TO:
import { generateCompletion, type ChatMessage } from '../lib/openai.js';
```

---

### File: `server/src/services/insightService.ts`
**Problem:** Unused import `InsightType` on line 5
**Fix:** The `InsightType` is imported but not used in this file (it's used in aiService instead).

**Line 5, change:**
```typescript
// FROM:
import type { InsightType, InsightQuery } from '@sleep-tracker/shared';

// TO:
import type { InsightQuery } from '@sleep-tracker/shared';
```

---

### File: `client/src/hooks/useSleepLogs.ts`
**Problem:** Unused import `SleepLog` on line 5
**Fix:** Remove unused type import.

**Line 4-13, change:**
```typescript
// FROM:
import type {
  SleepLog,
  CreateSleepLogInput,
  ...
} from '../types';

// TO:
import type {
  CreateSleepLogInput,
  UpdateSleepLogInput,
  SleepLogsResponse,
  SleepLogResponse,
  SleepStatsResponse,
  SuccessResponse,
  SleepLogQuery,
} from '../types';
```

---

### File: `client/src/hooks/useDiaryEntries.ts`
**Problem:** Unused import `DiaryEntry` on line 5
**Fix:** Remove unused type import.

**Line 4-13, change:**
```typescript
// FROM:
import type {
  DiaryEntry,
  CreateDiaryEntryInput,
  ...
} from '../types';

// TO:
import type {
  CreateDiaryEntryInput,
  UpdateDiaryEntryInput,
  DiaryEntriesResponse,
  DiaryEntryResponse,
  DiaryStatsResponse,
  SuccessResponse,
  DiaryEntryQuery,
} from '../types';
```

---

## Summary of Changes

| File | Change Type | Lines Affected |
|------|-------------|----------------|
| `server/src/middleware/auth.ts` | Fix JWT types + unused param | 2, 29-45, 106 |
| `shared/schemas/sleepLog.ts` | Add `.optional()` to query fields | 49-54 |
| `shared/schemas/diaryEntry.ts` | Add `.optional()` to query fields | 58-63 |
| `client/src/pages/Register.tsx` | Change `hint` to `helperText` | 90 |
| `client/src/vite-env.d.ts` | CREATE new file | N/A |
| `client/src/lib/db.ts` | Fix `add()` function type | 99-101 |
| `server/src/routes/sleepLogs.ts` | Add `unknown` cast | 24 |
| `server/src/routes/diaryEntries.ts` | Add `unknown` cast | 24 |
| `server/src/jobs/insightGenerator.ts` | Remove unused `task` variable | 55 |
| `server/src/lib/migrate.ts` | Remove unused imports | 1-3 |
| `server/src/services/aiService.ts` | Remove unused `openai` import | 1 |
| `server/src/services/insightService.ts` | Remove unused `InsightType` import | 5 |
| `client/src/hooks/useSleepLogs.ts` | Remove unused `SleepLog` import | 5 |
| `client/src/hooks/useDiaryEntries.ts` | Remove unused `DiaryEntry` import | 5 |

---

## Verification

After implementing all fixes, Builder should verify by running:

```bash
# Server TypeScript check
cd server && npx tsc --noEmit

# Client TypeScript check
cd client && npx tsc --noEmit

# Or from root (if configured)
npm run typecheck
```

**Expected Result:** Zero TypeScript errors.

If verification passes, proceed to run the test suite:
```bash
npm test
```

**Note:** The project currently has zero test files. After TypeScript errors are fixed, creating test files will be a separate task.
